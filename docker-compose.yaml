services:

  spletni-streznik:
    build: 
      context: .
      dockerfile_inline: |
        FROM php:apache
        
        # 1. Namestitev Docker CLI, Git in orodij za spremembo uporabnikov
        RUN apt-get update && \
            apt-get install -y git gettext && \
            # Namestimo Docker CLI s curl 
            curl -fsSL https://download.docker.com/linux/static/stable/x86_64/docker-24.0.7.tgz | tar zx -C /usr/bin/ docker/docker && \
            
            # NOV POPRAVEK ZA IZVAJANJE DOCKER BINARNE DATOTEKE:
            # Zagotovimo, da je binarna datoteka v lasti uporabnika www-data in ima dovoljenje 755 (rwxr-xr-x).
            # To bi moralo 100% omogočiti izvajanje.
            chown www-data:www-data /usr/bin/docker && \
            chmod 755 /usr/bin/docker && \
            rm -rf /var/lib/apt/lists/*
            
        # 2. Namestitev PHP razširitev
        RUN docker-php-ext-install pdo pdo_mysql

    restart: unless-stopped
    ports:
      - "8000:80"
    volumes:
      # Mapiranje Docker Socketa
      # Upoštevajte, da mora uporabnik www-data zdaj dostopati do te vtičnice prek dovoljenj SKUPINE (root GID 0)
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data/www:/var/www
      
    # 3. Dodajanje uporabnika www-data k skupini root (GID 0) za dostop do socketa
    command: >
      /bin/sh -c "
        echo 'IZVEDBA POPRAVKA: Dodajanje www-data k skupini root (GID 0) IN Zagotovitev pravice do izvajanja binarne datoteke docker.';
        
        # Dodajanje uporabnika www-data k skupini root (za dostop do /var/run/docker.sock)
        usermod -a -G root www-data;
        
        echo 'Članstvo skupine uporabnika www-data:';
        id www-data;
        
        echo 'Dovoljenja binarne datoteke docker:';
        ls -l /usr/bin/docker;

        # Zaženemo glavni proces Apache
        exec apache2-foreground
      "

  mysql:
    hostname: podatkovna-baza
    image: mysql:latest
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=root
    volumes:
      - ./data/mysql:/var/lib/mysql
    ports:
      - "3307:3306" 

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    restart: unless-stopped
    ports:
      - "8001:80"
    environment:
      PMA_HOST: podatkovna-baza